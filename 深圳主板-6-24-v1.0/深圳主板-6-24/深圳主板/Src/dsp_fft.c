#include "table_fft.h"
#include "stm32_dsp.h"
#include "math.h"
#include "dsp_fft.h"


extern signed int ATT_UA[256];  //谐波UA
extern signed int ATT_UB[256];
extern signed int ATT_UC[256];
extern signed int ATT_IA[256];
extern signed int ATT_IB[256];
extern signed int ATT_IC[256];

float THD[6]={0};  //六个总谐波含量

int NPT=256;
long lBUFOUT[256];
long lBUFIN[256]={
6123,
5444,
4965,
4263,
3843,
3307,
2925,
2283,
2069,
738,
-1959,
-2120,
-2812,
-3142,
-3759,
-4074,
-4784,
-5250,
-5956,
-6343,
-6785,
-6965,
-7185,
-7319,
-7452,
-7570,
-7547,
-7519,
-7294,
-7154,
-6812,
-6588,
-6113,
-5709,
-5047,
-4452,
-3720,
-3076,
-2370,
-1693,
-977,
-224,
501,
1259,
1928,
2646,
3303,
4007,
4657,
5297,
5833,
6252,
6629,
6861,
7168,
7275,
7499,
7411,
7481,
7231,
7224,
6913,
6853,
6409,
6125,
5448,
4967,
4267,
3844,
3310,
2926,
2286,
2069,
749,
-1954,
-2120,
-2810,
-3140,
-3756,
-4072,
-4781,
-5249,
-5954,
-6342,
-6784,
-6965,
-7184,
-7320,
-7452,
-7572,
-7547,
-7520,
-7295,
-7156,
-6812,
-6591,
-6116,
-5712,
-5051,
-4455,
-3724,
-3080,
-2374,
-1697,
-981,
-228,
496,
1256,
1924,
2643,
3299,
4003,
4653,
5293,
5832,
6250,
6626,
6860,
7169,
7273,
7498,
7410,
7481,
7232,
7225,
6913,
6853,
6411,

6123,
5444,
4965,
4263,
3843,
3307,
2925,
2283,
2069,
738,
-1959,
-2120,
-2812,
-3142,
-3759,
-4074,
-4784,
-5250,
-5956,
-6343,
-6785,
-6965,
-7185,
-7319,
-7452,
-7570,
-7547,
-7519,
-7294,
-7154,
-6812,
-6588,
-6113,
-5709,
-5047,
-4452,
-3720,
-3076,
-2370,
-1693,
-977,
-224,
501,
1259,
1928,
2646,
3303,
4007,
4657,
5297,
5833,
6252,
6629,
6861,
7168,
7275,
7499,
7411,
7481,
7231,
7224,
6913,
6853,
6409,
6125,
5448,
4967,
4267,
3844,
3310,
2926,
2286,
2069,
749,
-1954,
-2120,
-2810,
-3140,
-3756,
-4072,
-4781,
-5249,
-5954,
-6342,
-6784,
-6965,
-7184,
-7320,
-7452,
-7572,
-7547,
-7520,
-7295,
-7156,
-6812,
-6591,
-6116,
-5712,
-5051,
-4455,
-3724,
-3080,
-2374,
-1697,
-981,
-228,
496,
1256,
1924,
2643,
3299,
4003,
4653,
5293,
5832,
6250,
6626,
6860,
7169,
7273,
7498,
7410,
7481,
7232,
7225,
6913,
6853,
6411,
}; 
long lBUFMAG[256];
float Content_Hwave[32]={0};
float Content_Hwave_Gain[32]=
{
	1.0,
	1.00362187060665,
	1.00969162604172,
	1.01825901332331,
	1.02939520355364,
	1.04319331488342,
	1.05977378492696,
	1.07927443401769,
	1.10187021533519,
	1.12776405100967,
	1.15718387269867,
	1.19042304659018,
	1.22777858879375,
	1.26962990669109,
	1.31639900106378,
	1.36856044411429,
	1.42671649331348,
	1.49149037623292,
	1.56363705732262,
	1.64398947583697,
	1.73366802372421,
	1.80207868,
	1.95697231,
	2.06131003,
	2.28241406,
	2.46224839,
	2.56360162,
	2.83706536,
	2.92904342,
	3.2643202,
	3.48424791
};






void powerMag(long nfill)  
{
  s16 lX,lY;
  uint32_t i;
	for (i=0; i < 256; i++)
  {
    lX= (lBUFOUT[i]<<16)>>16; 
    lY= (lBUFOUT[i] >> 16);
    {
      float X=  NPT*((float)lX)/32768;
      float Y = NPT*((float)lY)/32768;
			float Mag = sqrt((X*X+ Y*Y));		 
			Mag = (Mag/nfill);		
      lBUFMAG[i] = Mag*65536;		 
    }    
  }
}

void Harmonic_Content_Calculate(unsigned char ph)  //谐波含有率计算
{
	
	float harmonic_sum = 0.0;
	switch(ph)
	{
		case 0:
			for(int i=0;i<256;i++)  
			{
				lBUFIN[i]=((s16)ATT_UA[i])<<16;
			}
			break;
		case 1:
			for(int i=0;i<256;i++)  
			{
				lBUFIN[i]=((s16)ATT_UB[i])<<16;
			}
			break;
		case 2:
			for(int i=0;i<256;i++)  
			{
				lBUFIN[i]=((s16)ATT_UC[i])<<16;
			}
			break;
		case 3:
			for(int i=0;i<256;i++)  
			{
				lBUFIN[i]=((s16)ATT_IA[i])<<16;
			}
			break;
		case 4:
			for(int i=0;i<256;i++)  
			{
				lBUFIN[i]=((s16)ATT_IB[i])<<16;
			}
			break;
		case 5:
			for(int i=0;i<256;i++)  
			{
				lBUFIN[i]=((s16)ATT_IC[i])<<16;
			}
			break;
		default:
			break;
	}	
		cr4_fft_256_stm32(lBUFOUT, lBUFIN, 256);
		powerMag(NPT);
		for(int k=1;k<33;k++)
		{
			Content_Hwave[k+1]=Content_Hwave_Gain[k]*100*(float)lBUFMAG[4*(k+1)]/(float)lBUFMAG[4];
		}
		
		float V1 = lBUFMAG[4];  // 基波幅值
		for (int k = 1; k <= 33; k++)   //总谐波含有率
		{
			float Vk = (float)lBUFMAG[4 * (k + 1)];
			harmonic_sum += Vk * Vk;
    }

    THD[ph] = sqrt(harmonic_sum) / V1;
}
